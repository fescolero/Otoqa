'use client';

import * as React from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card } from '@/components/ui/card';
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Users, UserCheck, AlertCircle, Clock, UserX, Trash } from 'lucide-react';
import { Doc } from '@/convex/_generated/dataModel';
import { FloatingActionBar } from './floating-action-bar';
import { DriverFilterBar, DriverFilterState } from './driver-filter-bar';
import { VirtualizedDriversTable } from './virtualized-drivers-table';
import { useQuery } from 'convex/react';
import { api } from '@/convex/_generated/api';

type Driver = Doc<'drivers'>;

interface DriverListProps {
  data: Driver[];
  organizationId: string;
  onDeactivateDrivers?: (driverIds: string[]) => Promise<void>;
}

const getDateStatus = (dateString?: string) => {
  if (!dateString) return 'valid';

  const date = new Date(dateString);
  date.setHours(0, 0, 0, 0);

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const diffTime = date.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays < 0) return 'expired';
  if (diffDays <= 30) return 'expiring';
  if (diffDays <= 60) return 'warning';
  return 'valid';
};

export function DriverList({ data, organizationId, onDeactivateDrivers }: DriverListProps) {
  const [activeTab, setActiveTab] = React.useState<string>('all');
  const [selectedDrivers, setSelectedDrivers] = React.useState<Set<string>>(new Set());
  const [focusedRowIndex, setFocusedRowIndex] = React.useState<number | null>(null);
  const [filters, setFilters] = React.useState<DriverFilterState>({
    search: '',
  });

  // Fetch driver counts for tab badges
  const driverCounts = useQuery(api.drivers.countDriversByStatus, {
    organizationId,
  });

  // Filter drivers based on search query and status
  const filteredDrivers = React.useMemo(() => {
    let filtered = data;

    // Apply search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(
        (driver) =>
          driver.firstName.toLowerCase().includes(query) ||
          driver.lastName.toLowerCase().includes(query) ||
          driver.email.toLowerCase().includes(query) ||
          driver.phone.includes(query) ||
          driver.licenseNumber.toLowerCase().includes(query),
      );
    }

    // Apply status filter
    if (filterStatus === 'deleted') {
      filtered = filtered.filter((driver) => driver.isDeleted === true);
    } else if (filterStatus === 'active') {
      filtered = filtered.filter((driver) => driver.employmentStatus === 'Active' && !driver.isDeleted);
    } else if (filterStatus === 'inactive') {
      filtered = filtered.filter((driver) => driver.employmentStatus === 'Inactive' && !driver.isDeleted);
    } else if (filterStatus === 'onleave') {
      filtered = filtered.filter((driver) => driver.employmentStatus === 'On Leave' && !driver.isDeleted);
    } else if (filterStatus === 'all') {
      filtered = filtered.filter((driver) => !driver.isDeleted);
    } else if (filterStatus === 'expiring') {
      filtered = filtered.filter((driver) => {
        const licenseStatus = getDateStatus(driver.licenseExpiration);
        const medicalStatus = getDateStatus(driver.medicalExpiration);
        const badgeStatus = getDateStatus(driver.badgeExpiration);
        const twicStatus = getDateStatus(driver.twicExpiration);

        return (
          licenseStatus === 'expired' ||
          licenseStatus === 'expiring' ||
          medicalStatus === 'expired' ||
          medicalStatus === 'expiring' ||
          badgeStatus === 'expired' ||
          badgeStatus === 'expiring' ||
          twicStatus === 'expired' ||
          twicStatus === 'expiring'
        );
      });
    }

    return filtered;
  }, [data, searchQuery, filterStatus]);

  // Count drivers needing attention
  const expiringCount = React.useMemo(() => {
    return data.filter((driver) => {
      const licenseStatus = getDateStatus(driver.licenseExpiration);
      const medicalStatus = getDateStatus(driver.medicalExpiration);
      const badgeStatus = getDateStatus(driver.badgeExpiration);
      const twicStatus = getDateStatus(driver.twicExpiration);

      return (
        licenseStatus === 'expired' ||
        licenseStatus === 'expiring' ||
        medicalStatus === 'expired' ||
        medicalStatus === 'expiring' ||
        badgeStatus === 'expired' ||
        badgeStatus === 'expiring' ||
        twicStatus === 'expired' ||
        twicStatus === 'expiring'
      );
    }).length;
  }, [data]);

  // Handle selection
  const handleSelectionChange = (driverId: string, selected: boolean) => {
    setSelectedDrivers((prev) => {
      const newSet = new Set(prev);
      if (selected) {
        newSet.add(driverId);
      } else {
        newSet.delete(driverId);
      }
      return newSet;
    });
  };

  const handleClearSelection = () => {
    setSelectedDrivers(new Set());
  };

  // Bulk action handlers
  const handleBulkMessage = () => {
    console.log('Message drivers:', Array.from(selectedDrivers));
    // TODO: Implement bulk message functionality
  };

  const handleBulkEdit = () => {
    console.log('Bulk edit drivers:', Array.from(selectedDrivers));
    // TODO: Implement bulk edit functionality
  };

  const handleBulkExport = () => {
    const selectedData = data.filter((driver) => selectedDrivers.has(driver._id));
    console.log('Export drivers:', selectedData);
    // TODO: Implement bulk export functionality
  };

  const handleBulkDeactivate = async () => {
    if (!onDeactivateDrivers) return;
    const driverIds = Array.from(selectedDrivers);
    await onDeactivateDrivers(driverIds);
    setSelectedDrivers(new Set()); // Clear selection after bulk action
  };

  const handleSelectAllInDatabase = () => {
    setSelectedDrivers(new Set(data.map((d) => d._id)));
  };

  // Check if all drivers are selected
  const isAllSelected = selectedDrivers.size > 0 && selectedDrivers.size === filteredDrivers.length;
  const isSomeSelected = selectedDrivers.size > 0 && selectedDrivers.size < filteredDrivers.length;
  const isAllInDatabaseSelected = selectedDrivers.size === data.length;

  // Handle select all from header
  const handleHeaderSelectAll = (checked: boolean) => {
    if (checked) {
      setSelectedDrivers(new Set(filteredDrivers.map((d) => d._id)));
    } else {
      setSelectedDrivers(new Set());
    }
  };

  return (
    <div className="space-y-4">
      {/* Filter Tabs */}
      <Tabs value={filterStatus} onValueChange={setFilterStatus} className="w-full">
        <TabsList className="inline-flex h-9 items-center justify-start rounded-lg bg-muted p-1 text-muted-foreground">
          <TabsTrigger value="all">All Drivers</TabsTrigger>
          <TabsTrigger value="active">Active</TabsTrigger>
          <TabsTrigger value="expiring" className="relative">
            Needs Attention
            {expiringCount > 0 && (
              <span className="ml-1.5 rounded-full bg-orange-500 px-2 py-0.5 text-xs font-semibold text-white">
                {expiringCount}
              </span>
            )}
          </TabsTrigger>
          <TabsTrigger value="onleave">On Leave</TabsTrigger>
          <TabsTrigger value="inactive">Inactive</TabsTrigger>
          <TabsTrigger value="deleted">Deleted</TabsTrigger>
        </TabsList>
      </Tabs>

      {/* Search and Action Buttons */}
      <div className="flex items-center justify-between gap-4">
        <div className="flex items-center gap-2 flex-1 max-w-sm">
          <div className="relative flex-1">
            <Search className="absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Search drivers..."
              value={searchQuery}
              onChange={(event) => setSearchQuery(event.target.value)}
              className="pl-8"
            />
          </div>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={onExportClick}>
            <Download className="mr-2 h-4 w-4" />
            Export CSV
          </Button>
          <Button variant="outline" size="sm" onClick={onImportClick}>
            <Upload className="mr-2 h-4 w-4" />
            Import CSV
          </Button>
          <Button size="sm" onClick={onCreateClick}>
            <Plus className="mr-2 h-4 w-4" />
            Create Driver
          </Button>
        </div>
      </div>

      {/* Table Header */}
      <DriverListHeader
        isAllSelected={isAllSelected}
        isSomeSelected={isSomeSelected}
        onSelectAll={handleHeaderSelectAll}
      />

      {/* Driver List */}
      <div className="space-y-2 overflow-x-auto">
        {filteredDrivers.length > 0 ? (
          filteredDrivers.map((driver) => (
            <DriverListItem
              key={driver._id}
              driver={driver}
              isSelected={selectedDrivers.has(driver._id)}
              onSelectionChange={handleSelectionChange}
            />
          ))
        ) : (
          <div className="flex items-center justify-center h-64 border border-dashed rounded-lg">
            <div className="text-center">
              <p className="text-muted-foreground mb-2">No drivers found</p>
              {searchQuery && (
                <Button variant="link" onClick={() => setSearchQuery('')}>
                  Clear search
                </Button>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Results Count */}
      <div className="flex items-center justify-between text-sm text-muted-foreground">
        <div>
          Showing {filteredDrivers.length} of {data.length} driver{data.length !== 1 ? 's' : ''}
        </div>
      </div>

      {/* Floating Action Bar */}
      <FloatingActionBar
        selectedCount={selectedDrivers.size}
        totalCount={data.length}
        isAllSelected={isAllInDatabaseSelected}
        onClearSelection={handleClearSelection}
        onSelectAll={filteredDrivers.length < data.length ? handleSelectAllInDatabase : undefined}
        onMessage={handleBulkMessage}
        onBulkEdit={handleBulkEdit}
        onExport={handleBulkExport}
        onDeactivate={handleBulkDeactivate}
      />
    </div>
  );
}
